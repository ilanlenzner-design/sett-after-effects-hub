<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SonicForge AI</title>
  <script src="../../../js/CSInterface.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0f1014;
      --card-bg: #1b1d22;
      --primary: #3ea6ff;
      --primary-hover: #5db0ff;
      --text: #ffffff;
      --text-muted: #889096;
      --border: #2a2d35;
      --radius: 12px;
    }

    body {
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
    }

    /* Modern Header */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px;
    }

    h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(90deg, #3ea6ff, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .badge {
      font-size: 10px;
      background: #2a2d35;
      padding: 4px 8px;
      border-radius: 999px;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Form Elements */
    .input-group {
      margin-bottom: 20px;
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    label {
      display: flex;
      justify-content: space-between;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    textarea {
      width: 100%;
      height: 80px;
      background: transparent;
      border: none;
      color: white;
      font-family: inherit;
      font-size: 14px;
      resize: none;
      outline: none;
    }

    textarea::placeholder {
      color: #4a5058;
    }

    /* Slider */
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #2a2d35;
      border-radius: 999px;
      outline: none;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 2px solid var(--bg-color);
      box-shadow: 0 0 0 2px var(--card-bg);
      transition: transform 0.1s;
    }

    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    /* Buttons */
    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary), #2979ff);
      color: white;
      border: none;
      border-radius: 999px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      box-shadow: 0 4px 12px rgba(62, 166, 255, 0.25);
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .import-btn {
      background: #2ecc71;
      margin-top: 12px;
      font-size: 12px;
      padding: 10px;
    }

    /* Status & Settings */
    .settings-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
    }

    .settings-btn:hover {
      color: white;
    }

    #playback-status {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 8px;
      height: 16px;
    }
  </style>
</head>

<body>

  <header>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3ea6ff" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M9 18V5l12-2v13"></path>
      <circle cx="6" cy="18" r="3"></circle>
      <circle cx="18" cy="16" r="3"></circle>
    </svg>
    <div>
      <h1>SonicForge</h1>
      <span class="badge">AI SOUND FX</span>
    </div>
    <button id="settings-btn" class="settings-btn" title="API Settings">⚙️</button>
  </header>

  <div class="input-group">
    <label>Prompt</label>
    <textarea id="prompt-input"
      placeholder="Describe a sound... e.g. 'Cinematic intense whoosh with digital glitch'"></textarea>
  </div>

  <div class="input-group">
    <label>
      <span>Duration</span>
      <span id="duration-val" style="color:var(--primary)">5s</span>
    </label>
    <div class="slider-container">
      <input type="range" id="duration-slider" min="1" max="30" step="0.5" value="5">
    </div>
    <div style="text-align: right; font-size: 10px; color: #555; margin-top: 4px;">*API limit: 30 seconds max</div>
  </div>

  <button id="generate-btn" class="btn-primary">Generate Sound</button>
  <div id="playback-status"></div>

  <!-- Container for dynamically added import button -->
  <div id="action-container"></div>

  <script>
    (function () {
      const els = {
        prompt: document.getElementById('prompt-input'),
        slider: document.getElementById('duration-slider'),
        durationLabel: document.getElementById('duration-val'),
        generateBtn: document.getElementById('generate-btn'),
        settingsBtn: document.getElementById('settings-btn'),
        status: document.getElementById('playback-status'),
        actions: document.getElementById('action-container')
      };

      // 1. API KEY LOGIC
      function getApiKey() {
        return localStorage.getItem('elevenlabs_api_key') || localStorage.getItem('sonic_forge_api_key');
      }

      els.settingsBtn.onclick = () => {
        const current = getApiKey() || '';
        const newKey = prompt('Enter ElevenLabs API Key:', current);
        if (newKey) {
          localStorage.setItem('elevenlabs_api_key', newKey.trim());
          alert("API Key saved!");
        }
      };

      // 2. SLIDER LOGIC
      els.slider.oninput = () => {
        els.durationLabel.innerText = els.slider.value + 's';
      };

      // 3. GENERATION LOGIC
      els.generateBtn.onclick = async () => {
        const key = getApiKey();
        if (!key) return alert("Please set API Key first (Gear Icon).");

        const text = els.prompt.value.trim();
        if (!text) return alert("Please enter a prompt.");

        const duration = parseFloat(els.slider.value);

        // UI Loading State
        els.generateBtn.disabled = true;
        els.generateBtn.innerText = "Generating...";
        els.status.innerText = "Processing with ElevenLabs...";
        els.actions.innerHTML = ""; // Clear old buttons

        try {
          const resp = await fetch('https://api.elevenlabs.io/v1/sound-generation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'xi-api-key': key
            },
            body: JSON.stringify({
              "text": text,
              "duration_seconds": duration, // Must be <= 22s usually for reliability, max 30s official
              "prompt_influence": 0.3
            })
          });

          if (!resp.ok) {
            const errBox = await resp.text();
            throw new Error("API Error: " + errBox);
          }

          const blob = await resp.blob();
          const arrayBuffer = await blob.arrayBuffer();

          // Save File (CEP) or Play (Web)
          if (window.cep) {
            const fs = require('fs');
            const path = require('path');
            const homeDir = process.env.HOME || process.env.USERPROFILE;
            const docPath = path.join(homeDir, "Documents/SonicForge");
            if (!fs.existsSync(docPath)) fs.mkdirSync(docPath, { recursive: true });

            const safeName = text.slice(0, 15).replace(/[^a-z0-9]/gi, '_');
            const filePath = path.join(docPath, `SFX_${safeName}_${Date.now()}.mp3`);

            fs.writeFileSync(filePath, Buffer.from(arrayBuffer));

            els.status.innerText = "Saved to Documents!";
            createImportButton(filePath);

            // Preview
            new Audio(filePath).play();
          } else {
            // Browser fallback
            const url = URL.createObjectURL(blob);
            new Audio(url).play();
            els.status.innerText = "Playing preview...";
          }

        } catch (e) {
          alert(e.message);
          els.status.innerText = "Error occurred.";
        } finally {
          els.generateBtn.disabled = false;
          els.generateBtn.innerText = "Generate Sound";
        }
      };

      // 4. IMPORT LOGIC
      function createImportButton(path) {
        const btn = document.createElement('button');
        btn.className = 'btn-primary import-btn';
        btn.innerText = "⬇ Import to Timeline";
        btn.onclick = () => {
          if (window.__adobe_cep__) {
            const cs = new CSInterface();
            const safePath = path.replace(/\\/g, "\\\\");
            const script = `
                    try {
                        var io = new ImportOptions(File('${safePath}'));
                        if (io.canImportAs(ImportAsType.FOOTAGE)) {
                            var item = app.project.importFile(io);
                            if (app.project.activeItem instanceof CompItem) {
                                app.project.activeItem.layers.add(item);
                            }
                        }
                    } catch(e) { alert(e); }
                `;
            cs.evalScript(script);
          }
        };
        els.actions.appendChild(btn);
      }

    })();
  </script>
</body>

</html>